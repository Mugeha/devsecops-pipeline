name: Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  # ============================================================
  # JOB 1: SAST (Static Application Security Testing)
  # ============================================================
  sast-scan:
    name: SAST - Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            security-configs/semgrep-rules.yml
        continue-on-error: true
      
      - name: Upload SAST results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: sast-results
          path: semgrep.sarif

  # ============================================================
  # JOB 2: Secret Scanning
  # ============================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for secret scanning
      
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
        continue-on-error: true
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ============================================================
  # JOB 3: Dependency Scanning
  # ============================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './sample-app'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true
      
      - name: Upload Trivy results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: trivy-results
          path: trivy-results.sarif
      
      - name: Run Safety check (Python dependencies)
        run: |
          pip install safety
          safety check --file=sample-app/requirements.txt --json --output safety-report.json || true
        continue-on-error: true
      
      - name: Upload Safety results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: safety-results
          path: safety-report.json

  # ============================================================
  # JOB 4: Security Summary & Blocking
  # ============================================================
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [sast-scan, secret-scan, dependency-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Analyze security results
        run: |
          echo "==================================="
          echo "SECURITY SCAN SUMMARY"
          echo "==================================="
          
          # Count findings
          CRITICAL_COUNT=0
          HIGH_COUNT=0
          
          # Check if critical vulnerabilities found
          if [ -f "trivy-results/trivy-results.sarif" ]; then
            echo "Dependency scan completed"
          fi
          
          if [ -f "sast-results/semgrep.sarif" ]; then
            echo "SAST scan completed"
          fi
          
          echo ""
          echo "==================================="
          echo "SECURITY GATE: EVALUATING..."
          echo "==================================="
          
          # For now, always pass but show warnings
          if [ $CRITICAL_COUNT -gt 0 ]; then
            echo " WARNING: $CRITICAL_COUNT critical vulnerabilities found"
            echo "In production, this would BLOCK deployment"
          else
            echo "No critical vulnerabilities found"
          fi
          
          echo ""
          echo " See artifacts for detailed reports"
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Security Scan Results\n\n Security scans completed. Check the workflow artifacts for detailed reports.'
            })